# SpringBoot + React Demo

Modified from [the original repo](https://github.com/eugenp/tutorials/tree/master/spring-boot-modules/spring-boot-react/src/main/java/com/baeldung/springbootreact) with SpringBoot + MyBatis + ReactJS. A detailed tutorial of the original repository can be found at [the link here](https://www.baeldung.com/spring-boot-react-crud).

## I. SpringBoot Backend (with MyBatis as ORM)

Make sure to get the dependencies as indicated in the file `pom.xml`.

1. [**Configure the database connection**]
   - Before everything, we should configure our database connection and create some table structures in our database. Here I use PostgreSQL connection as an example. In a PostgreSQL database called `demo_db`, I created a schema called `client`, under which a table with the same name `client` was created.
    ```postgresql
    -- create a database called 'demo_db' in the instance of PostgreSQL
    -- and then run the SQL script
    
    drop schema if exists client cascade;
    
    create schema client;
    
    drop table if exists client.client;
    
    create table client.client
    (
        id    bigint generated by default as identity
            constraint client_pk
                primary key,
        first_name  varchar(32) not null,
        last_name  varchar(32) not null,
        email varchar(32) not null,
        gender int2 not null,   -- 0: female, 1: male, 2: others
            constraint email
                unique (email)  -- multi-column  candidate key
    );
    
    insert into client.client (first_name, last_name, email, gender)
        values ('Clyde', 'Burris', 'cburris0@mapquest.com', 1),
               ('Aline', 'Abela', 'aabela1@php.net', 0),
               ('Deina', 'Potte', 'dpotte2@flickr.com', 0),
               ('Malia', 'McGreil', 'mmcgreil3@hibu.com', 0),
               ('Terence', 'Crampin', 'tcrampin4@tripod.com', 1),
               ('Karissa', 'MacElane', 'kmacelane5@guardian.co.uk', 0),
               ('Margi', 'Newby', 'mnewby6@harvard.edu', 2),
               ('Dom', 'Sinclair', 'dsinclair7@g.co', 1),
               ('Gordie', 'Sperling', 'gsperling8@biblegateway.com', 1),
               ('Elysha', 'Shillum', 'eshillum9@prweb.com', 0),
               ('Benton', 'Slator', 'bslatora@so-net.ne.jp', 1),
               ('Clare', 'Rigts', 'crigtsb@elpais.com', 1),
               ('Winnie', 'Ramsdell', 'wramsdellc@bloomberg.com', 0),
               ('Dionne', 'Lomasna', 'dlomasnad@posterous.com', 2),
               ('Adorne', 'Goundrill', 'agoundrille@nih.gov', 0),
               ('Cesare', 'MacAnespie', 'cmacanespief@nasa.gov', 1),
               ('Leodora', 'Thatcham', 'lthatchamg@prnewswire.com', 0),
               ('Ahmad', 'Simmings', 'asimmingsh@is.gd', 1),
               ('Cchaddie', 'Twigley', 'ctwigleyi@about.com', 1),
               ('Jacquelyn', 'Robbey', 'jrobbeyj@wikispaces.com', 2);
    ```
   - After that, I configured the following in the `application.yml`, put under the folder `resources`.
    ```yml
    server:
      port: 8080
    spring:
      application:
        name: spring-react-demo
      datasource:
        driver-class-name: org.postgresql.Driver
        url: jdbc:postgresql://localhost:5432/demo_db
        username: postgres
        password: datagrip02
    ```
   Now the Java application can be connected to the PostgreSQL instance.
2. Structure of Content
   - main
     - java
       - com.jasonqiu.springbootreactdemo
         - controller
           - ClientController.java
         - entity
           - Client.java
         - repository
           - ClientRepository.java
         - service
           - ClientService.java
           - ClientServiceImpl.java
         - SpringbootReactDemoApplication.java
     - resources
       - application.yml
3. Intro to the five Java classes
   1. To create a Web service and connect to the database as the backend, we need to chain the following Java classes
     - (1) Controller: receives the requests from the clients.
     - (2) Service: handles the requests from the controller with the database operations defined in the repository. We create a Service interface and several implementation classes to manage the services.
     - (3) Repository: executes the database operations.
   2. (4) We have an entity class (Client.java) to bridge the Java application to the same table structure in the database.
   3. (5) We have a starter class to run the Java application.
4. Write the chain of Controller - Service - Repository
   1. `Repository`: First, we need an entity class to map to the database. After having the entity class `Client.java`, we can write our `ClientRepository.java` class and annotate the repository class with `@Mapper` (from MyBatis).
   2. `Service`: After having the repository, create an interface and one implementation class (or more) as a service. Annotate those implementations with `@Service`.
   3. `Controller`: Complete the RESTful Controller to handle client requests. Annotate with `@RestController`, as well as `@RequestMapping` before the class and every handler method.
5. Remember to add the annotations `@Autowired` to inject the fields, or use `final` fields and constructors instead for the usage of `ClientRepository` or `ClientController` in other classes.
6. Other issues
    - How to return the assigned id after insertion / update of a record?
      - Use `@Options(useGeneratedKeys = true, keyProperty = "client.id")` in the mapper / repository class
      - Use `client.getId()` after insertion / update to automatically retrieve the id in the table
    - How to generate a response
      - Use the class `ResponseEntity()`
    - Use `curl` to send HTTP requests for testing, for example
      - `curl -i -X PUT -H 'Content-Type: application/json' -d '{"id": 21, "firstName": "Jason", "lastName": "Qiu", "email": "jsqiu098@gmail.com", "gender": 1}' http://localhost:8091/clients/update/21`
        - and the output is
          ```
          HTTP/1.1 400 
          Content-Type: text/plain;charset=UTF-8
          Content-Length: 36
          Date: Fri, 12 Aug 2022 23:52:41 GMT
          Connection: close

          The record with id 21 does not exis
          ```
      - `curl -i -X POST -H 'Content-Type: application/json' -d '{"firstName": "Jason", "lastName": "Qiu", "email": "jsqiu098@gmail.com", "gender": 1}' http://localhost:8091/clients/create`
          - and the output is
            ```
            HTTP/1.1 201 
            Location: /clients/21
            Content-Type: application/json
            Transfer-Encoding: chunked
            Date: Fri, 12 Aug 2022 23:51:07 GMT

            {"id":21,"firstName":"Jason","lastName":"Qiu","email":"jsqiu098@gmail.com","gender":1}
            ```
7. Use the command line `mvn spring-boot:run` to start the SpringBoot Application.

## II. React Frontend

1. Use `npx create-react-app frontend` to create a new React project. Enter the frontend project folder by `cd frontend`.
2. Install the dependencies
   - `npm install react-router-dom@6 --save`
   - `npm install @mui/material @emotion/react @emotion/styled`
   - `npm install @mui/icons-material`
   - `npm install prop-types --save`
   - `npm install react-draggable`
3. Other issues
   - Use nested routes and `<Outlet />` tag to create children routes.
   - In MUI, use `sx={{ textTransform: 'none' }}` to remove capitalization of Button
   - Make sure the keys of the iterated components are unique.
   - Use `disableGutters` to remove the padding of the Toolbar component in MUI
   - `&nbsp;` and `&emsp;`
   - Pass arguments to `TablePaginationActions`
     - `ActionsComponent={(subProps) => <TablePaginationActions {...subProps} editMode={editMode} />}`

## III. Spring Security

A feasible solution:
- Login
  1. Define a new login interface that
    - Calls the methods of `ProviderManager` for authentication, and generates jwt if authentication passes
    - Stores the user information into Redis
  2. Define a new class `UserDetailsService`
    - Query the database of user login details
- Authentication
  1. Define a jwt authentication filter that
    - Gets token
    - Parses token and gets userid from jwt
    - Gets user info from Redis
    - Stores into `SecurityContextHolder`

1. Create classes including `JwtUtils.java`, `RedisConfig.java`, `RedisCache.java`, `WebUtils.java` and some entity classes including `UserInfo.java`; create sql files and corresponding databases. Here I created the table in `user_info.user` within the database `demo_db`.
2. Implement `UserDetailsService` with `UserDetailsServiceImpl.java` (annotated with `@Service`) and make the first test. Note that the plain text passwords need to prefix with `{noop}`. This is because the default password encoder uses the format `{id}password` as the way of encoding. We should probably overwrite this password encoder with our own implementation.
3. 

